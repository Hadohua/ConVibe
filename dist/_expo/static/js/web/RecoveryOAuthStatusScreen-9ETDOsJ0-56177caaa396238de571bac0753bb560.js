__d(function(g,_r,_i,_a,_m,_e,_d){"use strict";Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"RecoveryOAuthScreen",{enumerable:!0,get:function(){return _}}),Object.defineProperty(_e,"default",{enumerable:!0,get:function(){return _}});var e=_r(_d[0]),t=_r(_d[1]),r=_r(_d[2]),a=_r(_d[3]),o=_r(_d[4]),c=_r(_d[5]),i=_r(_d[6]),l=_r(_d[7]),n=_r(_d[8]),d=_r(_d[9]),s=_r(_d[10]),u=_r(_d[11]),h=_r(_d[12]),v=_r(_d[13]);async function w({url:e,popup:t,provider:r}){return t.location=e,new Promise((e,r)=>{function a(){t?.close(),window.removeEventListener("message",o)}function o(t){t.data&&("PRIVY_OAUTH_RESPONSE"===t.data.type&&t.data.stateCode&&t.data.authorizationCode&&(e(t.data),a()),"https://cdn.apple-cloudkit.com"===t.origin&&t.data.ckSession&&(e({type:"PRIVY_OAUTH_RESPONSE",ckWebAuthToken:t.data.ckSession}),a()),"PRIVY_OAUTH_ERROR"===t.data.type&&(r(t.data.error),a()))}window.addEventListener("message",o)})}async function p({api:e,provider:t,stateCode:r,codeVerifier:a,authorizationCode:o}){if(!o||!r)throw new l.a("[OAuth AuthFlow] Authorization and state codes code must be set prior to calling authenicate.");if("undefined"===o)throw new l.a("User denied confirmation during OAuth flow");try{return(await e.post(d.a8,{authorization_code:o,state_code:r,code_verifier:a,provider:t})).access_token}catch(e){let t=(0,l.f)(e);if(t.privyErrorCode)throw new l.a(t.message||"Invalid code during OAuth flow.",void 0,t.privyErrorCode);if("User denied confirmation during OAuth flow"===t.message)throw new l.a("Invalid code during oauth flow.",void 0,l.b.OAUTH_USER_DENIED);throw new l.a("Invalid code during OAuth flow.",void 0,l.b.UNKNOWN_AUTH_ERROR)}}async function y({api:e,provider:t}){let r=(0,i.v)(),a=(0,i.w)(),o=await(0,i.x)(r);try{return"icloud"===t?{url:(await e.post(d.a9,{client_type:"web"})).url}:{url:(await e.post(d.aa,{redirect_to:window.location.href,code_challenge:o,state_code:a})).url,codeVerifier:r,stateCode:a,provider:t}}catch(e){throw(0,l.f)(e)}}_r(_d[14]),_r(_d[15]),_r(_d[16]),_r(_d[17]),_r(_d[18]),_r(_d[19]),_r(_d[20]),_r(_d[21]),_r(_d[22]),_r(_d[23]),_r(_d[24]),_r(_d[25]),_r(_d[26]),_r(_d[27]),_r(_d[28]),_r(_d[29]),_r(_d[30]),_r(_d[31]),_r(_d[32]),_r(_d[33]),_r(_d[34]),_r(_d[35]),_r(_d[36]),_r(_d[37]),_r(_d[38]),_r(_d[39]),_r(_d[40]),_r(_d[41]),_r(_d[42]),_r(_d[43]),_r(_d[44]),_r(_d[45]),_r(_d[46]),_r(_d[47]),_r(_d[48]);let f={"google-drive":{name:"Google Drive",component:v.G},icloud:{name:"iCloud",component:v.A}};const _={component:()=>{let{logout:d}=(0,n.u)(),{navigate:_,setModalData:m,data:E}=(0,n.a)(),{closePrivyModal:A,createAnalyticsEvent:b}=(0,l.u)(),{execute:C}=(()=>{let{client:e,walletProxy:t,refreshSessionAndUser:r}=(0,l.u)(),{data:a}=(0,n.a)(),{user:o}=(0,n.u)(),c=(0,u.a)(),{create:i}=(0,h.u)();return{execute:async({provider:d,action:u,popup:h,shouldCreateEth:v,shouldCreateSol:f})=>{let _,m;if(!e)throw new l.a("Missing client");function E(t){if(!t&&e)throw e.createAnalyticsEvent({eventName:"recovery_oauth_error",payload:{error:"Unable to open recovery OAuth popup",provider:d}}),new l.a("Recovery OAuth failed")}switch(d){case"google-drive":{let t,r,{url:a,codeVerifier:o,stateCode:c}=await y({api:e.api,provider:d});E(a);try{let o=await w({url:a,popup:h,provider:d});if(t=o.stateCode,r=o.authorizationCode,t!==c)throw e.createAnalyticsEvent({eventName:"possible_phishing_attempt",payload:{provider:d,storedStateCode:c??"",returnedStateCode:t??""}}),new l.a("Unexpected auth flow. This may be a phishing attempt.",void 0,l.b.OAUTH_UNEXPECTED)}catch(t){throw e.createAnalyticsEvent({eventName:"recovery_oauth_error",payload:{error:t.toString(),provider:d}}),new l.a("Recovery OAuth failed")}[_,m]=await Promise.all([e.getAccessToken(),p({api:e.api,provider:d,codeVerifier:o,stateCode:t,authorizationCode:r})]);break}case"icloud":{let{url:t}=await y({api:e.api,provider:d});E(t);let{ckWebAuthToken:r}=await w({url:t,popup:h,provider:d});m=r,_=await e.getAccessToken()}}if(!t)throw new l.a("Cannot connect to wallet proxy");if(!_)throw new l.a("Unable to authorize user");switch(u){case"recover":{let r=a?.recoverWallet?.entropyId,o=a?.recoverWallet?.entropyIdVerifier;if(!r||!o)throw new l.a("Recovery OAuth failed");e.createAnalyticsEvent({eventName:"embedded_wallet_recovery_started",payload:{walletAddress:r,recoveryMethod:d}}),await t.recover({accessToken:_,entropyId:r,entropyIdVerifier:o,recoveryAccessToken:m}),e.createAnalyticsEvent({eventName:"embedded_wallet_recovery_completed",payload:{walletAddress:r,recoveryMethod:d}});break}case"create-wallet":{let t;if(e.createAnalyticsEvent({eventName:"embedded_wallet_creation_started"}),v&&f)t=await i({recoveryMethod:d,recoveryAccessToken:m,chainType:"ethereum",walletIndex:0,latestUser:o}),t=await i({chainType:"solana",walletIndex:0,latestUser:t.user});else if(f)t=await i({recoveryMethod:d,recoveryAccessToken:m,chainType:"solana",walletIndex:0,latestUser:o});else{if(!v)throw Error("Invalid args to create wallet");t=await i({recoveryMethod:d,recoveryAccessToken:m,chainType:"ethereum",walletIndex:0,latestUser:o})}if(!t)throw c("createWallet","onError",l.b.UNKNOWN_EMBEDDED_WALLET_ERROR),Error("Failed to create wallet");e.createAnalyticsEvent({eventName:"embedded_wallet_creation_completed",payload:{walletAddress:t.account.address}}),c("createWallet","onSuccess",{wallet:t.account});break}case"set-recovery":{let a=(0,n.g)(o);if(!a)throw c("setWalletRecovery","onError",l.b.EMBEDDED_WALLET_NOT_FOUND),Error("Embedded wallet not found");e.createAnalyticsEvent({eventName:"embedded_wallet_set_recovery_started",payload:{walletAddress:a.address,existingRecoveryMethod:a.recoveryMethod,targetRecoveryMethod:d}});let{entropyId:i,entropyIdVerifier:u}=(0,s.g)(o);await t.setRecovery({accessToken:_,entropyId:i,entropyIdVerifier:u,recoveryMethod:d,recoveryAccessToken:m});let h=(0,n.g)(await r());if(!h)throw c("createWallet","onError",l.b.UNKNOWN_EMBEDDED_WALLET_ERROR),Error("Failed to set recovery on wallet");e.createAnalyticsEvent({eventName:"embedded_wallet_set_recovery_completed",payload:{walletAddress:a.address,existingRecoveryMethod:a.recoveryMethod,targetRecoveryMethod:d}}),c("setWalletRecovery","onSuccess",{method:d,wallet:h});break}default:throw new l.a("Unsupported recovery action")}}}})(),[R,O]=(0,t.useState)(!1),{provider:T,action:k,isInAccountCreateFlow:x,shouldCreateEth:S,shouldCreateSol:N}=E?.recoveryOAuthStatus,[U,I]=(0,t.useState)(void 0),[M,W]=(0,t.useState)("create-wallet"===k);if("user-passcode"===T)throw Error("RecoveryOAuthScreen should never be called with a wallet that specifies recoveryMethod: `user-passcode`");let P=f[T].name,D=f[T].component,j=E?.recoverWallet?.onCompleteNavigateTo,V=new i.R(async(e="create-wallet")=>(W(!0),new Promise((t,r)=>{setTimeout(async()=>{try{let r=window.open();await C({provider:T,action:e,popup:r,shouldCreateEth:S,shouldCreateSol:N}),O(!0),t()}catch(t){I({message:`${"recover"===e?"Recovery":"Back up"} with ${P} unsuccessful`,detail:"recover"===k?`Please verify that you are selecting the ${P} account associated with your backup.`:"",retryable:!0}),r()}},0)})));(0,t.useEffect)(()=>{"recover"!==k&&V.execute(x?"create-wallet":"set-recovery")},[]),(0,t.useEffect)(()=>{if(!R)return;let e=setTimeout(()=>{x?(m({createWallet:{onSuccess:()=>{},onFailure:e=>{b({eventName:"embedded_wallet_creation_failure_logout",payload:{error:e,screen:"RecoveryOAuthScreen"}}),d()},callAuthOnSuccessOnClose:!0,shouldCreateEth:!1,shouldCreateSol:!1}}),_("EmbeddedWalletCreatedScreen")):A({shouldCallAuthOnSuccess:!1})},c.q);return()=>clearTimeout(e)},[R]);let F=(0,t.useCallback)(async()=>{await V.execute("recover"),j?_(j):O(!0)},[]),L="google-drive"===T?"Google Drive":"Apple iCloud",$=R&&`Successfully ${"recover"===k?"recovered":"backed up"} with ${L}.`||U&&U.message||`${"recover"===k?"Recovering":"Backing up"} with ${L}...`,z=U?U.detail:"";return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(a.M,{}),M?(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)(v.R,{children:[(0,e.jsx)(o.C,{title:$,icon:(0,e.jsx)(D,{style:{width:"38px",height:"38px"}}),description:z}),U&&U?.retryable?(0,e.jsx)(r.P,{onClick:()=>{(0,i.o)(),I(void 0),"create-wallet"===k?V.execute("create-wallet"):F()},disabled:!R&&!U?.retryable,children:"Try again"}):null]})}):(0,e.jsxs)(v.R,{children:[(0,e.jsx)(o.C,{title:"Confirm it's really you",icon:(0,e.jsx)(D,{style:{height:42,width:48}}),description:`To confirm your identity, please log in to ${L} where your account is backed up.`}),(0,e.jsxs)(r.P,{onClick:F,children:["Confirm with ",L]})]}),(0,e.jsx)(a.B,{})]})}}},4251,[16,14,4573,4575,4594,1557,783,1559,1556,1660,1594,1592,4643,4693,1568,1564,1565,1589,1591,784,1341,943,1160,1593,4576,4577,4578,4579,1558,1358,819,1595,1343,1654,1657,1661,1662,1663,1871,3739,1560,1389,3741,787,3742,1374,3748,3894,3895]);